Модель **EAV (Entity-Attribute-Value)** - это способ проектирования структуры базы данных, при котором вместо фиксированной схемы (с колонками под каждый атрибут) данные представляются в виде триады:
- **Entity (Сущность)** - объект, к которому относятся данные (например, товар, пользователь, пациент и т.п.).
- **Attribute (Атрибут)** - наименование свойства (например, цвет, возраст, температура).
- **Value (Значение)** - значение атрибута (например, "красный", "25", "36.6").
Пример:
```sql
CREATE TABLE eav_data (
    entity_id INT NOT NULL,
    attribute VARCHAR(255) NOT NULL,
    value TEXT,
    PRIMARY KEY (entity_id, attribute)
);
```

EAV - это не замена реляционной модели, а узкоспециализированное решение. Она подходит только в случаях, где структура данных нестабильна, заранее неизвестна или сильно разрежена.
- каталоги товаров с разными категориями(хранение характеристик у разных типов товаров)
- медицинские системы (сотни параметров пациента)
- динамические поля в формах (Form Builder, CRM, ERP c кастомными атрибутами)

Область применения сильно пересекается с NoSQL-решениями и/или хранениями данных в JSON/JSONB поля в Posgres/MySQL.

**Когда лучше использовать JSON/JSONB**
- у сущности есть динамические или вложенные поля, которые редко запрашиваются по отдельности
- уже используется PostgreSQL
- нужно хранить сложные структуры (массивы, объекты, вложенные словари)

**Когда лучше использовать EAV**
- динамические поля для большой номенклатуры (например, каталог товаров)
- атрибуты у объектов редко повторяются (разреженные)
- важно нормализовать атрибуты (например, единицы измерения, типы, метаинформация и т.д. )
- требуется частый поиск, фильтрация и анализ по значениям, особенно по вложенным

**В реальности используется гибридный подход:**
- Основные атрибуты (часто используемые, индексируемые) - как отдельные колонки
- динамические / дополнительные атрибуты - в JSONB
- реплика для BI -  в EAV + кеш для агрегаций


**Пример:**

**movies** - основной фильм
```sql
CREATE TABLE movies (   -- сущность / Entity / Кино
    id,
    title
);
```

| id  | title     |
| --- | --------- |
| 1   | Inception |

---
**attribute_types** - типы данных
```sql
CREATE TABLE attribute_types (   -- типы данных атрибутов
    id
    name                         -- названия типа (string, int, bool, date, и т.п.)
);
```

| id  | name    |
| --- | ------- |
| 1   | string  |
| 2   | integer |
| 3   | boolean |

---
**attributes** - определяем, какие характеристики могут быть у фильма
```sql
CREATE TABLE attributes (  
    id
    name						 -- название атрибута (genre, director, budget, и т.д.)	
    attribute_type_id			 -- ссылка на attribute_types.id
);
```

| id  | name       | attribute_type_id |
| --- | ---------- | ----------------- |
| 1   | genre      | 1 (`string`)      |
| 2   | duration   | 2 (`int`)         |
| 3   | has_sequel | 3 (`boolean`)     |

---
**eav_values** - значения этих атрибутов для фильма `Inception` (`movie_id = 1`)
```sql
CREATE TABLE eav_values (        -- значения атрибутов 
	id							 -- уникальный идентификатор
	movie_id					 -- ссылка на movies(id)
	attribute_id                 -- ссылка на attributes(id)
	value_string                 -- значение, если тип string
	value_int					 -- значение, если тип integer
	value_bool					 -- значение, если тип boolean
	value_date					 -- значение, если тип date
	value_float					 -- значение, если float
);
```

| id  | movie_id | attribute_id | value_string | value_int | value_bool |
| --- | -------- | ------------ | ------------ | --------- | ---------- |
| 1   | 1        | 1 (genre)    | sci-fi       | NULL      | NULL       |
| 2   | 1        | 2 (duration) | NULL         | 148       | NULL       |
| 3   | 1        | 3 (has_seq.) | NULL         | NULL      | false      |
В этой таблице для каждого `movie_id` и `attribute_id` у нас хранится **только одно активное поле** из `value_*`, в зависимости от типа.

---

Например, вытянуть все атрибуты фильма `Inception` (ID = 1):
```sql
SELECT 
  a.name AS attribute_name,
  COALESCE(ev.value_string, ev.value_int::TEXT, ev.value_bool::TEXT) AS value
FROM eav_values ev
JOIN attributes a ON ev.attribute_id = a.id
WHERE ev.movie_id = 1;

```





#php/db #computer-science
